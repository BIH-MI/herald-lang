<!--
Human-Centric Extraction for Research and Analysis of Longitudinal Data (HERALD)

Module: Test

Copyright (C) 2023 - 2024 - 2024 - BIH Medical Informatics Group

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<html>
    <head>
        <title>Test</title>
        <script src="../libs/moo.min.js"></script>
        <script src="../libs/nearley.min.js"></script>
        <script src="herald-lexer.js"></script>
        <script src="herald-grammar.js"></script>
        <script src="herald-interpreter.js"></script>
    </head>
    <body>
        <script lang="javascript">
            const testObservations = [
              new QueryableObservation("HeartRate", "2023-01-01T08:00:00", "2023-01-01T08:00:00", true, 75, "bpm"),
              new QueryableObservation("HeartRate", "2023-01-02T08:00:00", "2023-01-02T08:00:00", true, 80, "bpm"),
              new QueryableObservation("BloodPressure", "2023-01-01T08:00:00", "2023-01-01T08:00:00", true, [120, 80], "mmHg"),
              new QueryableObservation("BloodPressure", "2023-01-02T08:00:00", "2023-01-02T08:00:00", true, [125, 75], "mmHg"),
              new QueryableObservation("BloodSugar", "2023-01-01T08:00:00", "2023-01-01T08:00:00", true, 90, "mg/dL"),
              new QueryableObservation("BloodSugar", "2023-01-02T08:00:00", "2023-01-02T08:00:00", true, 100, "mg/dL"),
              new QueryableObservation("Temperature", "2023-01-01T08:00:00", "2023-01-01T08:00:00", true, 98.6, "°F"),
              new QueryableObservation("Temperature", "2023-01-02T08:00:00", "2023-01-02T08:00:00", true, 99.1, "°F"),
              new QueryableObservation("RespiratoryRate", "2023-01-01T08:00:00", "2023-01-01T08:00:00", true, 16, "bpm"),
              new QueryableObservation("RespiratoryRate", "2023-01-02T08:00:00", "2023-01-02T08:00:00", true, 18, "bpm"),
              new QueryableObservation("Temperature", "2023-01-01T08:00:00", "2023-01-01T08:00:00", true, 98.2, "°F"),
              new QueryableObservation("Temperature", "2023-01-02T08:00:00", "2023-01-02T08:00:00", true, 99.1, "°F"),
              new QueryableObservation("Temperature", "2023-01-03T08:00:00", "2023-01-03T08:00:00", true, 98.4, "°F"),
              new QueryableObservation("SystolicBloodPressure", "2023-01-10T10:00:00", "2023-01-10T10:10:00", true, 120, "mmHg"),
              new QueryableObservation("SystolicBloodPressure", "2023-01-11T10:00:00", "2023-01-11T10:10:00", true, 125, "mmHg"),
              new QueryableObservation("SystolicBloodPressure", "2023-01-12T10:00:00", "2023-01-12T10:10:00", true, 110, "mmHg"),
              new QueryableObservation("HeartRate", "2023-01-10T10:00:00", "2023-01-10T10:10:00", true, 80, "bpm"),
              new QueryableObservation("HeartRate", "2023-01-11T10:00:00", "2023-01-11T10:10:00", true, 85, "bpm"),
              new QueryableObservation("HeartRate", "2023-01-12T10:00:00", "2023-01-12T10:10:00", true, 75, "bpm"),
              new QueryableObservation("Weight", "2023-01-10T10:00:00", "2023-01-10T10:10:00", true, 75, "kg"),
              new QueryableObservation("Weight", "2023-01-11T10:00:00", "2023-01-11T10:10:00", true, 76, "kg"),
              new QueryableObservation("Weight", "2023-01-12T10:00:00", "2023-01-12T10:10:00", true, 74, "kg"),
              new QueryableObservation("Height", "2023-01-10T10:00:00", "2023-01-10T10:10:00", true, 180, "cm"),
            ];

            const aggregationQueries = [
              // (120 + 125 + 110) / 3 = 118.33
              'AVERAGE ("SystolicBloodPressure")',
              
              // There are 3 SystolicBloodPressure observations
              'COUNT ("SystolicBloodPressure")',
              
              // SUM heart_rate: 80 + 85 + 75 + 75 + 80 = 395
              'SUM ("HeartRate")',
              
              // MIN weight: The minimum weight value is 74
              'MIN ("Weight")',
              
              // MAX height: The maximum height value is 180
              'MAX ("Height")',

              // 75 or 80
              'MOST FREQUENT ("HeartRate")'
            ];

            const filterTestQueries = [
              // 1. Find the first observation with a heart rate greater than 75 bpm.
              // Expected result: A single QueryableObservation object with a heart rate of 80 bpm.
              "FIRST ((VALUE > \"75\") AND (LABEL = \"HeartRate\"))",
              "LAST (\"HeartRate\" > \"75\")",
              "FIRST (\"HeartRate\")",
              
              // 2. Find the last observation with systolic blood pressure between 120 and 130 mmHg.
              // Expected result: A single QueryableObservation object with blood pressure [125, 75] mmHg.
              "LAST ((VALUE >= \"120\") AND (VALUE <= \"130\") AND (LABEL = \"BloodPressure\"))",
              
              // 3. Find any blood sugar observation that occurred before or on 2023-01-01.
              // Expected result: A single QueryableObservation object with a blood sugar of 90 mg/dL.
              "ANY ((START <= \"2023-01-01T23:59:59\") AND (LABEL = \"BloodSugar\"))",
              
              // 4. Find the first observation where the diastolic blood pressure is less than 80 mmHg and the heart rate is greater than or equal to 80 bpm.
              // Expected result: A single QueryableObservation object with a heart rate of 80 bpm.
              "FIRST (((VALUE < \"80\") AND (LABEL = \"BloodPressure\")) OR ((VALUE >= \"80\") AND (LABEL = \"HeartRate\")))",
              
              // 5. Find the last observation where the temperature is greater than 98.6 °F.
              // Expected result: A single QueryableObservation object with a temperature of 99.1 °F.
              "LAST (\"Temperature\" > \"98.6\")"
            ];

            const filterTestQueriesWithTemporal = [
              // 1. Find the first observation with a heart rate greater than 75 bpm before 2023-01-02.
              // Expected result: No results, as the observation with a heart rate greater than 75 bpm happens on 2023-01-02.
              "FIRST (VALUE > \"75\" AND LABEL = \"HeartRate\") BEFORE (2023-01-02)",
              
              // 2. Find the last observation with systolic blood pressure between 120 and 130 mmHg after 2023-01-01.
              // Expected result: A single QueryableObservation object with blood pressure [125, 75] mmHg.
              "LAST (VALUE >= \"120\" AND VALUE <= \"130\" AND LABEL = \"BloodPressure\") AFTER (2023-01-01)",
              
              // 3. Find any blood sugar observation that occurred close to a heart rate observation.
              // Expected result: A single QueryableObservation object with a blood sugar of 90 mg/dL.
              "FIRST (LABEL = \"BloodSugar\") CLOSE TO (LABEL = \"HeartRate\")",
              
              // 4. Find the first observation where the diastolic blood pressure is less than 80 mmHg before and close to a heart rate observation by 1 day.
              // Expected result: A single QueryableObservation object with blood pressure [125, 75] mmHg.
              "FIRST (VALUE < \"80\" AND LABEL = \"BloodPressure\") BEFORE AND CLOSE TO (LABEL = \"HeartRate\") BY 1 DAY",
              
              // 5. Find the last observation where the temperature is greater than 98.6 °F before or on 2023-01-02 and apart from a heart rate observation by at least 2 days.
              // Expected result: No results, as there is no temperature observation meeting the criteria.
              "LAST (VALUE > \"98.6\" AND LABEL = \"Temperature\") APART FROM (LABEL = \"HeartRate\") BY 2 DAYS"
            ];

            const comparisonQueries = [
              // Ratios between matching pairs of HeartRate and SystolicBloodPressure
              'RATIO BETWEEN (LABEL = "HeartRate") AND (LABEL = "SystolicBloodPressure")',
              
              // Differences between matching pairs of Temperature and BloodSugar
              'DIFFERENCE BETWEEN (LABEL = "Temperature") AND (LABEL = "BloodSugar")',
              
              // Whether the RespiratoryRate and HeartRate values are equal
              'EQUALITY OF (LABEL = "RespiratoryRate") AND (LABEL = "HeartRate")',
              
              // Ratios between matching pairs of Weight and Height
              'RATIO BETWEEN (LABEL = "Weight") AND (LABEL = "Height")',
              
              // Differences between matching pairs of BloodSugar and Temperature before 2023-01-03
              'DIFFERENCE BETWEEN (LABEL = "BloodSugar") AND (LABEL = "Temperature") BEFORE (2023-01-03)',
              
              // Whether the BloodPressure and SystolicBloodPressure values are equal after 2023-01-01
              'EQUALITY OF (LABEL = "BloodPressure") AND (LABEL = "SystolicBloodPressure") AFTER (2023-01-01)',
            ];

            const searchQueries = [
              // Expected result: true
              'EXISTS (LABEL = "BloodPressure" AND START = "2023-01-01T08:00:00" AND END = "2023-01-01T08:00:00")',

              // Expected result: true
              'EXISTS (LABEL = "HeartRate")',

              // Expected result: true
              'NOT EXISTS (LABEL = "PulseOximetry")',

              // Expected result: true
              'EXISTS (LABEL = "BloodSugar" AND VALUE >= "90")',

              // Expected result: false
              'EXISTS (LABEL = "HeartRate" AND VALUE < "70")',

              // Expected result: true
              'NOT EXISTS (LABEL = "Temperature" AND VALUE > "99.5")',

              // Expected result: true
              'EXISTS (LABEL = "HeartRate" AND VALUE > "78") AND EXISTS (LABEL = "Temperature" AND VALUE < "98.4")',

              // Expected result: true
              'EXISTS (LABEL = "BloodPressure") AND NOT EXISTS (LABEL = "RespiratoryRate" AND VALUE > "17") BEFORE (2023-01-02)',

              // Expected result: false
              'EXISTS (LABEL = "BloodSugar" AND VALUE > "95") AND EXISTS (LABEL = "Weight" AND VALUE > "75") AND NOT EXISTS (LABEL = "Height" AND VALUE = "180")',
            ];

            const complexQueries = [
              // 1. Find the average temperature between 2023-01-01 and 2023-01-03
              'AVERAGE ("Temperature" AND START >= "2023-01-01" AND START <= "2023-01-03")',

              // 2. Find the sum of systolic blood pressure where the heart rate is less than or equal to 80 bpm
              'SUM ("SystolicBloodPressure") CLOSE TO (LABEL = "HeartRate" AND VALUE <= "80") BY 1 DAY',

              // 3. Find the first heart rate after a temperature observation with value greater than 98.6 °F
              // Expected result: A single QueryableObservation object with a heart rate of 80 bpm
              'FIRST ("HeartRate") AFTER (LABEL = "Temperature" AND VALUE > "98.6")',

              // 4. Find the last observation where the blood sugar value is greater than 90 and the diastolic blood pressure is less than 80 mmHg
              // Expected result: A single QueryableObservation object with a blood sugar of 100 mg/dL
              'LAST (LABEL = "BloodSugar" AND VALUE > "90") CLOSE TO (LABEL = "BloodPressure" AND VALUE < "80") BY 1 DAY',

              // 5. Find the count of temperature observations that occurred before or close to a heart rate observation by 1 day
              // Expected result: 4
              'COUNT ("Temperature") BEFORE AND CLOSE TO (LABEL = "HeartRate") BY 1 DAY',

              // 6. Find the minimum heart rate value when respiratory rate is greater than or equal to 16 bpm
              // Expected result: 75
              'MIN ("HeartRate") CLOSE TO (LABEL = "RespiratoryRate" AND VALUE >= "16") BY 1 DAY',

              // 7. Find the maximum systolic blood pressure value when the blood pressure systolic component is less than 130 mmHg
              // Expected result: 125
              'MAX ("SystolicBloodPressure") CLOSE TO (LABEL = "BloodPressure" AND VALUE < "130") BY 1 DAY',

              // 8. Find the difference between the heart rate and the systolic blood pressure
              'DIFFERENCE BETWEEN ("HeartRate") AND ("SystolicBloodPressure")',

              // 9. Check if any temperature observation exists when the heart rate is greater than 75 bpm
              'EXISTS (LABEL = "Temperature") CLOSE TO (LABEL = "HeartRate" AND VALUE > "75") BY 1 DAY',

              // 10. Find the count of observations where blood sugar is between 90 and 100 mg/dL and the diastolic blood pressure is less than or equal to 80 mmHg
              // Expected result: 2
              'COUNT (LABEL = "BloodSugar" AND VALUE >= "90" AND VALUE <= "100") CLOSE TO (LABEL = "BloodPressure" AND VALUE <= "80") BY 1 DAY'
            ];

            // Parse the input string
            for (query of complexQueries) {
              console.log("Executing: " + query);
              console.log(executeHERALD(query, testObservations));
            }
            for (query of searchQueries) {
              console.log("Executing: " + query);
              console.log(executeHERALD(query, testObservations));
            }
            for (query of comparisonQueries) {
              console.log("Executing: " + query);
              console.log(executeHERALD(query, testObservations));
            }
            for (query of aggregationQueries) {
              console.log("Executing: " + query);
              console.log(executeHERALD(query, testObservations));
            }
            for (query of filterTestQueries) {
              console.log("Executing: " + query);
              console.log(executeHERALD(query, testObservations));
            }
            for (query of filterTestQueriesWithTemporal) {
              console.log("Executing: " + query);
              console.log(executeHERALD(query, testObservations));
            }

            // Instantiate a parser with your grammar
            const parser = new nearley.Parser(nearley.Grammar.fromCompiled(grammar));
        </script>
    </body>
</html>